# Story 1.6: 前後端路由保護

## Status
Approve

## Story
**As a** 已登入使用者,
**I want** 能夠存取受保護的頁面，而未登入者不能,
**so that** 我知道我的帳號是安全的。

## Acceptance Criteria
1. 前端建立一個受保護的路由（例如 `/dashboard`）。
2. 未登入的使用者訪問 `/dashboard` 時，會被自動導向 `/login` 頁面。
3. 後端建立一個受保護的 API 端點，只有在請求標頭附帶有效 JWT 時才能成功訪問。

## Tasks / Subtasks
- [ ] Task 1: Enhance existing middleware for comprehensive route protection (AC: 1, 2)
  - [ ] Subtask 1.1: Review and improve existing middleware.ts for robust route protection
  - [ ] Subtask 1.2: Add support for dynamic protected routes and user role-based access
  - [ ] Subtask 1.3: Implement proper redirect handling with return URL functionality
  - [ ] Subtask 1.4: Add comprehensive error handling and fallback mechanisms
- [ ] Task 2: Implement tRPC procedure-level authentication middleware (AC: 3)
  - [ ] Subtask 2.1: Create tRPC authentication middleware for protected procedures
  - [ ] Subtask 2.2: Integrate JWT verification with tRPC context
  - [ ] Subtask 2.3: Add user information to tRPC context for protected procedures
  - [ ] Subtask 2.4: Implement proper error responses for unauthorized requests
- [ ] Task 3: Create protected API endpoints and test authentication (AC: 3)
  - [ ] Subtask 3.1: Create sample protected tRPC procedures for testing
  - [ ] Subtask 3.2: Add user profile API endpoint requiring authentication
  - [ ] Subtask 3.3: Implement proper authorization checks in business logic
  - [ ] Subtask 3.4: Add comprehensive error handling for authentication failures
- [ ] Task 4: Enhance frontend authentication flow and protected components (AC: 1, 2)
  - [ ] Subtask 4.1: Create higher-order component (HOC) for protected pages
  - [ ] Subtask 4.2: Implement loading states during authentication verification
  - [ ] Subtask 4.3: Add automatic token refresh mechanism for near-expiry tokens
  - [ ] Subtask 4.4: Handle authentication errors gracefully with user feedback
- [ ] Task 5: Comprehensive testing of authentication and authorization (AC: 1, 2, 3)
  - [ ] Subtask 5.1: Write integration tests for middleware route protection
  - [ ] Subtask 5.2: Test tRPC authentication middleware with various scenarios
  - [ ] Subtask 5.3: Test protected API endpoints with valid and invalid tokens
  - [ ] Subtask 5.4: Test frontend authentication flow and protected components
  - [ ] Subtask 5.5: Test edge cases and error scenarios

## Dev Notes
### Previous Story Insights
From Story 1.5 completion:
- Authentication system fully implemented with JWT storage and Zustand state management
- Basic middleware.ts already created for route protection (QA enhancement in Story 1.5)
- tRPC client configured with automatic authentication header injection
- Login/dashboard pages working with authentication flow
- Comprehensive authentication context available throughout the application
- Token storage utilities with validation and expiry checking implemented

### Data Models
From Architecture Document [Source: docs/fullstack-architecture.md#第四章]:
- **User:** User model with id, email, passwordHash, createdAt, updatedAt fields
- JWT payload structure: { userId: string, email: string, iat: number, exp: number }
- Authentication context provides User interface without password information

### API Specifications
From Architecture Document [Source: docs/fullstack-architecture.md#第五章]:
- **API Method:** tRPC for end-to-end type safety with authentication middleware
- **Auth Router:** Existing auth.login and auth.register procedures available
- **Main Routers:** authRouter, datasetRouter (to be protected), chatRouter (to be protected)
- tRPC procedures can be protected using authentication middleware

### Backend Architecture
From Architecture Document [Source: docs/fullstack-architecture.md#第十一章]:
- **Service Architecture:** Serverless-style services in Next.js API Routes with layered design
- **Authentication Architecture:** NextAuth.js for auth flow, Middleware and tRPC procedures for authorization
- **Repository Pattern:** Data access through repository pattern with user context

### Frontend Architecture  
From Architecture Document [Source: docs/fullstack-architecture.md#第十章]:
- **Component Architecture:** Functional organization with shared components
- **Route Protection:** Next.js App Router with Middleware for route protection
- **State Management:** Zustand authentication context for application-wide auth state
- **Navigation Flow:** Login → Dashboard → Protected Routes

### File Locations
Based on Project Structure [Source: docs/fullstack-architecture.md#第十二章]:
- **Middleware:** `/apps/web/src/middleware.ts` (already exists, needs enhancement)
- **tRPC Middleware:** `/apps/web/src/server/api/middleware/auth.ts`
- **Protected Components:** `/apps/web/src/components/auth/ProtectedRoute.tsx`
- **HOC Components:** `/apps/web/src/components/auth/withAuth.tsx`
- **Protected API Examples:** `/apps/web/src/server/api/routers/user.ts`
- **Tests:** Adjacent to source files or in `__tests__` directories

### Testing Requirements
From Architecture Document [Source: docs/fullstack-architecture.md#第十六章]:
- **Testing Framework:** Vitest for unit and integration tests
- **Strategy:** Testing pyramid principle with focus on authentication middleware
- **Test Organization:** Tests colocated with source code
- Build on existing test patterns from Stories 1.1-1.5

### Technical Constraints
From Architecture Document [Source: docs/fullstack-architecture.md#第三章]:
- **Backend Language:** TypeScript ~5.4
- **Backend Framework:** Next.js API Routes ~14.2
- **API Integration:** tRPC ~11.0 with authentication middleware support
- **Authentication:** NextAuth.js ~5.0 (beta) integration with existing JWT system
- **Database:** PostgreSQL 16 with Prisma ORM

### Security Considerations
From Architecture Document [Source: docs/fullstack-architecture.md#第十五章]:
- JWT token validation must be comprehensive and secure
- Proper error handling without exposing sensitive information
- Route protection must handle both client-side and server-side rendering
- Authorization checks must be implemented at multiple layers
- Token expiration and refresh handling for continuous security

### Component Specifications
From Frontend Specification [Source: docs/front-end-spec.md#第四章]:
- **Protected Layout:** Dashboard layout with navigation and user information
- **Route Protection:** Automatic redirects with loading states
- **Error Handling:** User-friendly error messages for authentication failures
- **Navigation:** Consistent navigation patterns across protected routes

### Error Handling
From Architecture Document [Source: docs/fullstack-architecture.md#第十八章]:
- Standardized error return format for authentication failures
- Unified error catching and presentation mechanism
- Proper HTTP status codes for authentication/authorization errors
- Client-side error handling with user feedback and retry options

### Performance Considerations
- Efficient token validation without excessive API calls
- Optimized middleware execution to minimize request latency
- Proper caching strategies for authentication state
- Minimize authentication checks while maintaining security

### Integration Requirements
- Seamless integration with existing authentication system from Stories 1.3-1.5
- Build upon existing middleware.ts created in Story 1.5 QA review
- Utilize existing tRPC client authentication header injection
- Leverage existing Zustand authentication context and token storage utilities

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-08-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
[To be filled during implementation]

### Debug Log References
[To be filled during implementation]

### Completion Notes List
[To be filled during implementation]

### File List
[To be filled during implementation]