# Story 1.3: 使用者註冊 API 端點

## Status
Done

## Story
**As a** 新使用者,
**I want** 透過 API 註冊一個新帳號,
**so that** 我可以開始使用這個平台。

## Acceptance Criteria
1. 建立 `POST /api/auth/register` 端點。
2. 端點能接收 `email` 和 `password`。
3. 密碼在存入資料庫前必須經過雜湊 (hashing) 處理。
4. 成功註冊後，回傳成功的訊息；若使用者已存在，則回傳錯誤訊息。

## Tasks / Subtasks
- [x] Task 1: Set up password hashing utility (AC: 3)
  - [x] Subtask 1.1: Install bcrypt or argon2 for password hashing
  - [x] Subtask 1.2: Create password utility functions (hash, verify)
  - [x] Subtask 1.3: Add password strength validation
  - [x] Subtask 1.4: Write unit tests for password utilities
- [x] Task 2: Create tRPC authentication router (AC: 1, 2)
  - [x] Subtask 2.1: Set up tRPC server structure in Next.js API routes
  - [x] Subtask 2.2: Create authRouter with register procedure  
  - [x] Subtask 2.3: Define input validation schema for email and password
  - [x] Subtask 2.4: Configure error handling and response formats
- [x] Task 3: Implement user registration service (AC: 2, 3, 4)
  - [x] Subtask 3.1: Create user registration service using repository pattern
  - [x] Subtask 3.2: Integrate password hashing in registration flow
  - [x] Subtask 3.3: Handle duplicate email registration attempts
  - [x] Subtask 3.4: Implement proper error responses and success messages
- [x] Task 4: Create API endpoint integration (AC: 1)
  - [x] Subtask 4.1: Set up Next.js API route at /api/trpc/[trpc].ts
  - [x] Subtask 4.2: Configure tRPC server with authRouter
  - [x] Subtask 4.3: Test API endpoint accessibility and routing
- [x] Task 5: Write comprehensive tests (AC: 1, 2, 3, 4)
  - [x] Subtask 5.1: Write integration tests for registration endpoint
  - [x] Subtask 5.2: Test password hashing functionality
  - [x] Subtask 5.3: Test duplicate email handling
  - [x] Subtask 5.4: Test input validation and error scenarios
  - [x] Subtask 5.5: Test success response format

## Dev Notes
### Previous Story Insights
From Story 1.2:
- Next.js web application established in apps/web directory
- Prisma ORM configured with PostgreSQL provider
- User model implemented with proper schema and constraints
- User repository available with CRUD operations including email validation
- Vitest testing framework configured and working

### Data Models
From Architecture Document [Source: docs/fullstack-architecture.md#第四章]:
- **User:** 儲存使用者認證資訊 - already implemented in Story 1.2
- User model has id, email, passwordHash, createdAt, updatedAt fields
- Email must be unique constraint enforced at database level

### API Specifications
From Architecture Document [Source: docs/fullstack-architecture.md#第五章]:
- **API Method:** tRPC for end-to-end type safety
- **Main Routers:** authRouter handles registration and login
- **API Style:** Next.js API Routes with tRPC [Source: docs/fullstack-architecture.md#第三章]

### Component Specifications
From Architecture Document [Source: docs/fullstack-architecture.md#第十一章]:
- **Backend Architecture:** Next.js API Routes implementing Serverless-style services
- **Layered Design:** Routers, Services, Repositories pattern - repository already exists
- **Authentication:** NextAuth.js for auth flow [Source: docs/fullstack-architecture.md#第三章]

### File Locations
Based on Unified Project Structure [Source: docs/fullstack-architecture.md#第十二章]:
- tRPC server setup: `/apps/web/src/server/api/` directory
- API route: `/apps/web/src/pages/api/trpc/[trpc].ts` or `/apps/web/src/app/api/trpc/[trpc]/route.ts` (App Router)
- Auth router: `/apps/web/src/server/api/routers/auth.ts`
- Password utilities: `/apps/web/src/lib/auth/password.ts`
- User service: `/apps/web/src/lib/services/user.service.ts`
- Tests: Adjacent to source files or in `/apps/web/src/__tests__/`

### Testing Requirements
From Architecture Document [Source: docs/fullstack-architecture.md#第十六章]:
- **Testing Framework:** Vitest for unit and integration tests (already configured)
- **Strategy:** Follow testing pyramid principle, MVP phase focuses on Vitest unit/integration tests
- **Organization:** Test files colocated with source code

### Technical Constraints
From Architecture Document [Source: docs/fullstack-architecture.md#第三章]:
- **Backend Language:** TypeScript ~5.4
- **API Framework:** tRPC ~11.0 for end-to-end type safety
- **Authentication:** NextAuth.js ~5.0 (beta)
- **Database:** PostgreSQL 16 with Prisma ORM (already configured)

### Security Considerations
From Architecture Document [Source: docs/fullstack-architecture.md#第十五章]:
- Backend API security requirements defined
- Password hashing required (bcrypt or argon2 recommended)
- Input validation essential for email and password
- Error handling should not expose sensitive information
- Environment variables for security configuration

### Error Handling
From Architecture Document [Source: docs/fullstack-architecture.md#第十八章]:
- Standardized error return format required
- Unified error catching and presentation mechanism
- Proper HTTP status codes for different scenarios

### Testing
From Architecture Document [Source: docs/fullstack-architecture.md#第十六章]:
- **Framework:** Vitest for unit/integration tests (already configured)
- **Test Organization:** Tests colocated with source code
- Implement tests for:
  - API endpoint registration flow
  - Password hashing and validation
  - Input validation and sanitization
  - Error scenarios (duplicate email, invalid input)
  - Success response format

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-08-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
No critical debug logs generated during implementation.

### Completion Notes List
- Successfully implemented bcrypt password hashing with strength validation
- Created comprehensive tRPC authentication router with proper error handling
- Implemented user registration service following repository pattern
- Set up Next.js API routes with tRPC integration
- All tests passing for implemented features
- Password hashing tests: 18/18 passing
- User service tests: 8/8 passing  
- Auth router tests: 9/9 passing

### File List
**Created Files:**
- `/apps/web/src/lib/auth/password.ts` - Password utility functions
- `/apps/web/src/lib/auth/password.test.ts` - Password utility tests
- `/apps/web/src/lib/auth/constants.ts` - Authentication constants and error messages (QA refactoring)
- `/apps/web/src/server/api/trpc.ts` - tRPC server configuration
- `/apps/web/src/server/api/routers/auth.ts` - Authentication router
- `/apps/web/src/server/api/root.ts` - Root router configuration
- `/apps/web/src/app/api/trpc/[trpc]/route.ts` - Next.js API route
- `/apps/web/src/lib/services/user.service.ts` - User registration service
- `/apps/web/src/lib/services/user.service.test.ts` - User service tests
- `/apps/web/src/server/api/routers/auth.test.ts` - Auth router tests

**Modified Files:**
- `/apps/web/package.json` - Added tRPC and bcrypt dependencies
- `/apps/web/src/lib/auth/password.ts` - Enhanced with constants and trim validation (QA refactoring)
- `/apps/web/src/server/api/routers/auth.ts` - Enhanced email handling and constants (QA refactoring)
- `/apps/web/src/lib/services/user.service.ts` - Conditional logging and constants (QA refactoring)  
- `/apps/web/src/lib/services/user.service.test.ts` - Updated for refactored behavior (QA refactoring)

## QA Results

### Review Date: 2025-08-05

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

**EXCELLENT** - The implementation demonstrates high-quality craftsmanship with proper separation of concerns, comprehensive error handling, and robust testing. The developer followed architectural guidance precisely and implemented all acceptance criteria with attention to security and maintainability.

Key strengths:
- Proper layered architecture (Router → Service → Repository)
- Comprehensive input validation at multiple layers
- Security-first approach with bcrypt hashing and password strength validation
- Excellent test coverage (35/35 tests passing)
- Consistent error handling patterns
- Type safety throughout with TypeScript and Zod

### Refactoring Performed

Senior developer refactoring improvements made:

- **File**: `/apps/web/src/lib/auth/constants.ts` (NEW)
  - **Change**: Created centralized constants file for all authentication-related configuration and error messages
  - **Why**: Eliminates magic strings/numbers, enables consistent messaging, simplifies maintenance
  - **How**: Improves maintainability by centralizing all auth-related constants in one location

- **File**: `/apps/web/src/lib/auth/password.ts`
  - **Change**: Enhanced input validation with `.trim()` checks and adopted centralized constants
  - **Why**: More robust validation prevents whitespace-only passwords, centralized constants improve maintainability
  - **How**: Prevents edge cases and makes error messages consistent across the application

- **File**: `/apps/web/src/server/api/routers/auth.ts`
  - **Change**: Enhanced email validation with `.trim().toLowerCase()` and centralized error messages
  - **Why**: Ensures consistent email handling, prevents case sensitivity issues, unified error messaging
  - **How**: Improves user experience and data consistency

- **File**: `/apps/web/src/lib/services/user.service.ts`
  - **Change**: Conditional logging (development-only) and centralized error messages
  - **Why**: Prevents sensitive information exposure in production logs, consistent error handling
  - **How**: Enhances security posture while maintaining debugging capabilities in development

- **File**: `/apps/web/src/lib/services/user.service.test.ts`
  - **Change**: Updated tests to account for conditional logging behavior
  - **Why**: Tests must validate the actual behavior after refactoring
  - **How**: Ensures tests accurately reflect production behavior

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to TypeScript best practices, proper async/await usage
- **Project Structure**: ✓ Perfect alignment with unified project structure, files in correct locations
- **Testing Strategy**: ✓ Outstanding test coverage following testing pyramid principles
- **All ACs Met**: ✓ All acceptance criteria fully implemented and validated

### Improvements Checklist

Refactoring completed by senior developer:

- [x] Created centralized constants file for maintainability (constants.ts)
- [x] Enhanced input validation with trim() checks (password.ts, auth.ts)
- [x] Implemented conditional logging for security (user.service.ts)
- [x] Added email normalization (toLowerCase) for consistency (auth.ts)
- [x] Updated all tests to validate refactored behavior (user.service.test.ts)
- [x] Eliminated magic strings/numbers throughout codebase
- [x] Verified all 35 tests pass after refactoring

Additional recommendations for future stories:
- [ ] Consider implementing rate limiting for registration endpoint
- [ ] Add email verification workflow in future authentication stories
- [ ] Consider implementing password history tracking
- [ ] Add comprehensive API integration tests with actual HTTP calls

### Security Review

**EXCELLENT** - Robust security implementation:

✅ **Password Security**: bcrypt with 12 salt rounds (industry standard)
✅ **Input Validation**: Multi-layer validation (Zod + custom validation)
✅ **Error Handling**: No sensitive information exposure
✅ **Logging**: Development-only error logging prevents production info leaks
✅ **Type Safety**: End-to-end type safety with tRPC
✅ **Email Normalization**: Prevents case sensitivity issues

### Performance Considerations

**GOOD** - Appropriate for current requirements:

✅ **Password Hashing**: bcrypt salt rounds (12) balanced for security vs performance
✅ **Database Queries**: Efficient single queries, no N+1 issues
✅ **Error Handling**: Proper async/await patterns throughout
✅ **Validation**: Input validation happens before expensive operations

### Final Status

**✓ APPROVED - Ready for Done**

Outstanding implementation with proactive senior developer refactoring completed. All acceptance criteria met with enhanced maintainability, security, and code quality. The story demonstrates production-ready code that exceeds expectations for a registration endpoint.