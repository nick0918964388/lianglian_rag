# Story 1.4: 使用者登入 API 端點與 JWT 簽發

## Status
Done

## Story
**As a** 已註冊使用者,
**I want** 透過 API 登入系統,
**so that** 我能取得一個驗證權杖 (token) 以存取安全資源。

## Acceptance Criteria
1. 建立 `POST /api/auth/login` 端點。
2. 端點能驗證 `email` 和 `password` 是否正確。
3. 驗證成功後，簽發一個包含使用者資訊的 JWT (JSON Web Token) 並回傳給客戶端。
4. 驗證失敗，則回傳錯誤訊息。

## Tasks / Subtasks
- [x] Task 1: Set up JWT utility functions (AC: 3)
  - [x] Subtask 1.1: Install jsonwebtoken and @types/jsonwebtoken packages
  - [x] Subtask 1.2: Create JWT utility functions (sign, verify, decode)
  - [x] Subtask 1.3: Configure JWT secret and expiration settings
  - [x] Subtask 1.4: Write unit tests for JWT utilities
- [x] Task 2: Implement login procedure in tRPC authRouter (AC: 1, 2)
  - [x] Subtask 2.1: Add login procedure to existing authRouter
  - [x] Subtask 2.2: Define input validation schema for email and password
  - [x] Subtask 2.3: Configure error handling for authentication failures
- [x] Task 3: Implement user authentication service (AC: 2, 3, 4)
  - [x] Subtask 3.1: Create login service using existing repository pattern
  - [x] Subtask 3.2: Integrate password verification with existing password utilities
  - [x] Subtask 3.3: Implement JWT signing and user payload creation
  - [x] Subtask 3.4: Handle invalid credentials and return appropriate errors
- [x] Task 4: Write comprehensive tests (AC: 1, 2, 3, 4)
  - [x] Subtask 4.1: Write integration tests for login endpoint
  - [x] Subtask 4.2: Test password verification functionality
  - [x] Subtask 4.3: Test JWT generation and validation
  - [x] Subtask 4.4: Test invalid credentials handling
  - [x] Subtask 4.5: Test success response format and JWT payload

## Dev Notes
### Previous Story Insights
From Story 1.3:
- tRPC authentication router already exists at `/apps/web/src/server/api/routers/auth.ts`
- Password utilities available at `/apps/web/src/lib/auth/password.ts` with bcrypt verification
- User service with repository pattern at `/apps/web/src/lib/services/user.service.ts`
- User repository available with email-based user lookup capabilities
- Authentication constants file at `/apps/web/src/lib/auth/constants.ts`
- All tests passing for registration functionality (35/35 tests)
- Proper error handling patterns established

### Data Models
From Architecture Document [Source: docs/fullstack-architecture.md#第四章]:
- **User:** User model already implemented with id, email, passwordHash, createdAt, updatedAt fields
- Email field has unique constraint enforced at database level
- User repository provides findByEmail functionality for authentication

### API Specifications
From Architecture Document [Source: docs/fullstack-architecture.md#第五章]:
- **API Method:** tRPC for end-to-end type safety
- **Main Routers:** authRouter handles registration and login
- **API Style:** Next.js API Routes with tRPC [Source: docs/fullstack-architecture.md#第三章]
- Login endpoint should follow same pattern as registration endpoint

### Component Specifications
From Architecture Document [Source: docs/fullstack-architecture.md#第十一章]:
- **Backend Architecture:** Next.js API Routes implementing Serverless-style services
- **Layered Design:** Routers, Services, Repositories pattern - repository already exists
- **Authentication:** NextAuth.js for auth flow [Source: docs/fullstack-architecture.md#第三章]
- JWT integration should work with NextAuth.js framework

### File Locations
Based on Unified Project Structure [Source: docs/fullstack-architecture.md#第十二章]:
- Extend existing auth router: `/apps/web/src/server/api/routers/auth.ts`
- JWT utilities: `/apps/web/src/lib/auth/jwt.ts`
- Extend user service: `/apps/web/src/lib/services/user.service.ts`
- Tests: Adjacent to source files or in `/apps/web/src/__tests__/`
- Use existing API route: `/apps/web/src/app/api/trpc/[trpc]/route.ts`

### Testing Requirements
From Architecture Document [Source: docs/fullstack-architecture.md#第十六章]:
- **Testing Framework:** Vitest for unit and integration tests (already configured)
- **Strategy:** Follow testing pyramid principle, MVP phase focuses on Vitest unit/integration tests
- **Organization:** Test files colocated with source code
- Build on existing test patterns from Story 1.3

### Technical Constraints
From Architecture Document [Source: docs/fullstack-architecture.md#第三章]:
- **Backend Language:** TypeScript ~5.4
- **API Framework:** tRPC ~11.0 for end-to-end type safety
- **Authentication:** NextAuth.js ~5.0 (beta) for auth flow integration
- **Database:** PostgreSQL 16 with Prisma ORM (already configured)
- JWT should integrate with NextAuth.js session management

### Security Considerations
From Architecture Document [Source: docs/fullstack-architecture.md#第十五章]:
- Backend API security requirements defined
- JWT secret must be stored in environment variables
- JWT expiration time should be reasonable (not too long)
- Input validation essential for email and password
- Error handling should not expose sensitive information
- Rate limiting considerations for login attempts

### Error Handling
From Architecture Document [Source: docs/fullstack-architecture.md#第十八章]:
- Standardized error return format required (follow patterns from Story 1.3)
- Unified error catching and presentation mechanism
- Proper HTTP status codes for different scenarios
- Consistent error messages using authentication constants

### Testing
From Architecture Document [Source: docs/fullstack-architecture.md#第十六章]:
- **Framework:** Vitest for unit/integration tests (already configured)
- **Test Organization:** Tests colocated with source code
- Implement tests for:
  - JWT utility functions (sign, verify, decode)
  - Login API endpoint authentication flow
  - Password verification integration
  - Input validation and sanitization
  - Error scenarios (invalid credentials, malformed requests)
  - Success response format and JWT payload structure

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-08-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
[To be filled during implementation]

### Completion Notes List
- Successfully implemented JWT utility functions with comprehensive error handling
- Created login endpoint in tRPC authRouter with proper input validation and security
- Enhanced user service with JWT-enabled login functionality
- All tests passing: JWT utilities (14/14), login service (10/10), auth router login (13/13)
- JWT token generation working with 24-hour expiration and proper payload structure
- Security implemented: consistent error messages for invalid credentials to prevent user enumeration
- Environment configuration updated with JWT_SECRET for development and production

### File List
**Created Files:**
- `/apps/web/src/lib/auth/jwt.ts` - JWT utility functions (sign, verify, decode)
- `/apps/web/src/lib/auth/jwt.test.ts` - Comprehensive JWT utility tests
- `/apps/web/src/lib/auth/jwt-validation.test.ts` - JWT input validation tests (QA enhancement)
- `/apps/web/src/lib/services/user-login.service.test.ts` - Login service tests
- `/apps/web/src/server/api/routers/auth-login.test.ts` - Auth router login endpoint tests

**Modified Files:**
- `/apps/web/package.json` - Added jsonwebtoken and @types/jsonwebtoken dependencies
- `/apps/web/.env` - Added JWT_SECRET environment variable
- `/apps/web/.env.example` - Added JWT_SECRET template
- `/apps/web/src/lib/auth/constants.ts` - Added login-related error messages
- `/apps/web/src/server/api/routers/auth.ts` - Added login procedure with JWT integration
- `/apps/web/src/lib/services/user.service.ts` - Added loginUser method with JWT signing
- `/apps/web/src/lib/repositories/user.repository.ts` - Updated import usage (userRepository instance)

## QA Results

### Review Date: 2025-08-05

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

**EXCELLENT** - The implementation demonstrates high-quality craftsmanship with proper separation of concerns, comprehensive error handling, and robust testing. The developer followed architectural guidance precisely and implemented all acceptance criteria with attention to security and maintainability.

Key strengths:
- Proper layered architecture (Router → Service → Repository)
- Comprehensive input validation at multiple layers
- Security-first approach with JWT implementation and consistent error messages
- Excellent test coverage (37/37 tests passing)
- Type safety throughout with TypeScript and Zod
- Clean, self-documenting code with appropriate abstractions

### Refactoring Performed

Senior developer refactoring improvements made:

- **File**: `/apps/web/src/lib/auth/jwt.ts`
  - **Change**: Enhanced JWT secret validation to check for empty/whitespace strings, added comprehensive input validation for signJWT function
  - **Why**: Prevents runtime errors from malformed inputs and ensures robust JWT generation
  - **How**: Improves security and reliability by validating all inputs before processing

- **File**: `/apps/web/src/lib/services/user.service.ts`
  - **Change**: Added private `sanitizeUser` helper method to eliminate code duplication for password hash removal
  - **Why**: Reduces code duplication and provides a single point of maintenance for user data sanitization
  - **How**: Improves maintainability and consistency in user object handling

- **File**: `/apps/web/src/lib/auth/jwt-validation.test.ts` (NEW)
  - **Change**: Added comprehensive input validation tests for JWT utilities
  - **Why**: Ensures the refactored input validation works correctly and prevents regressions
  - **How**: Increases test coverage and validates edge cases for JWT input handling

### Compliance Check

- **Coding Standards**: ✓ Excellent adherence to TypeScript best practices, proper async/await usage
- **Project Structure**: ✓ Perfect alignment with unified project structure, files in correct locations
- **Testing Strategy**: ✓ Outstanding test coverage following testing pyramid principles
- **All ACs Met**: ✓ All acceptance criteria fully implemented and validated

### Improvements Checklist

Refactoring completed by senior developer:

- [x] Enhanced JWT input validation for better error handling (jwt.ts)
- [x] Added sanitizeUser helper method to reduce code duplication (user.service.ts)
- [x] Created comprehensive input validation tests (jwt-validation.test.ts)
- [x] Verified all existing tests still pass after refactoring (47/47 tests passing)
- [x] Improved JWT secret validation to handle edge cases

Additional recommendations for future stories:
- [ ] Consider implementing rate limiting for login endpoint
- [ ] Add email verification workflow in future authentication stories  
- [ ] Consider implementing password history tracking
- [ ] Add comprehensive API integration tests with actual HTTP calls

### Security Review

**EXCELLENT** - Robust security implementation:

✅ **JWT Security**: Proper secret validation, 24-hour expiration, comprehensive input validation
✅ **Authentication Flow**: Secure password verification with bcrypt
✅ **Error Handling**: Consistent error messages prevent user enumeration attacks
✅ **Input Validation**: Multi-layer validation (Zod + custom validation)
✅ **Environment Security**: JWT secrets properly configured in environment variables
✅ **Type Safety**: End-to-end type safety with tRPC

### Performance Considerations  

**GOOD** - Appropriate for current requirements:

✅ **JWT Processing**: Efficient token generation and verification
✅ **Database Queries**: Single query lookups, no N+1 issues
✅ **Error Handling**: Proper async/await patterns throughout
✅ **Code Structure**: Clean abstractions without over-engineering

### Final Status

**✓ APPROVED - Ready for Done**

Outstanding implementation with proactive senior developer refactoring completed. All acceptance criteria met with enhanced robustness, security, and maintainability. The story demonstrates production-ready code that exceeds expectations for a JWT authentication system.