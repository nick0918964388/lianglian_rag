# Story 1.2: 使用者模型與資料庫設定

## Status
Done

## Story
**As a** 系統,
**I want** 一個基礎的使用者資料模型與資料庫連接,
**so that** 使用者資訊可以被安全地儲存與讀取。

## Acceptance Criteria
1. 定義使用者 (User) 的資料庫綱要 (Schema)，至少包含 `email`, `password_hash`。
2. 後端應用程式能成功連接到指定的資料庫。
3. 建立一個資料庫遷移 (migration) 腳本，用於生成 `users` 資料表。

## Tasks / Subtasks
- [x] Task 1: Set up Next.js web application with Prisma and PostgreSQL (AC: 2)
  - [x] Subtask 1.1: Create apps/web directory and initialize Next.js application
  - [x] Subtask 1.2: Install and configure Prisma ORM
  - [x] Subtask 1.3: Set up PostgreSQL connection via DATABASE_URL environment variable
  - [x] Subtask 1.4: Create Prisma client configuration in `/apps/web/src/lib/db.ts`
  - [x] Subtask 1.5: Add connection error handling and database utility functions
- [x] Task 2: Define User model in Prisma schema (AC: 1)
  - [x] Subtask 2.1: Create `/apps/web/prisma/schema.prisma` with PostgreSQL provider
  - [x] Subtask 2.2: Define User model with id, email, password_hash fields
  - [x] Subtask 2.3: Add email unique constraint and proper indexes
  - [x] Subtask 2.4: Add createdAt and updatedAt timestamp fields
  - [x] Subtask 2.5: Validate schema syntax and field types
- [x] Task 3: Create and run initial database migration (AC: 3)
  - [x] Subtask 3.1: Generate initial Prisma migration for User model
  - [x] Subtask 3.2: Review generated migration SQL
  - [x] Subtask 3.3: Add npm scripts for Prisma commands (generate, migrate, studio)
  - [x] Subtask 3.4: Test migration execution and rollback capability
- [x] Task 4: Implement User repository with Prisma (AC: 1, 2)
  - [x] Subtask 4.1: Create User repository at `/apps/web/src/lib/repositories/user.repository.ts`
  - [x] Subtask 4.2: Implement CRUD operations using Prisma client
  - [x] Subtask 4.3: Add email validation and uniqueness checks
  - [x] Subtask 4.4: Implement proper error handling for database operations
- [x] Task 5: Write unit tests using Vitest (AC: 1, 2, 3)
  - [x] Subtask 5.1: Set up Vitest configuration for apps/web
  - [x] Subtask 5.2: Create test database setup and teardown utilities
  - [x] Subtask 5.3: Write unit tests for User repository CRUD operations
  - [x] Subtask 5.4: Test database connection and Prisma client functionality
  - [x] Subtask 5.5: Test email validation and constraint enforcement

## Dev Notes
### Previous Story Insights
From Story 1.1:
- Monorepo structure established with apps/backend directory
- TypeScript configuration available via @lianglian-rag/tsconfig
- ESLint configuration available via @lianglian-rag/eslint-config-custom
- Backend package.json already created at apps/backend/package.json

### Data Models
From Architecture Document [Source: docs/fullstack-architecture.md#第四章]:
- **User:** 儲存使用者認證資訊
- Database Schema includes users, datasets, files tables [Source: docs/fullstack-architecture.md#第九章]

User model should include:
- id: Primary key 
- email: String, unique, required
- password_hash: String, required (never store plain passwords)
- created_at: Timestamp
- updated_at: Timestamp

### API Specifications
From Architecture Document [Source: docs/fullstack-architecture.md#第五章]:
- **API Method:** tRPC for end-to-end type safety
- **Main Routers:** authRouter handles registration and login
- **API Style:** Next.js API Routes with tRPC [Source: docs/fullstack-architecture.md#第三章]

### Component Specifications
From Architecture Document [Source: docs/fullstack-architecture.md#第十一章]:
- **Backend Architecture:** Next.js API Routes implementing Serverless-style services
- **Layered Design:** Routers, Services, Repositories pattern
- **Database Architecture:** Use Prisma as ORM with Repository pattern for data access

### File Locations
Based on Unified Project Structure [Source: docs/fullstack-architecture.md#第十二章]:
Since this is a Next.js-based backend (not separate Node.js service):
- Database configuration: `/apps/web/src/lib/db.ts` (Prisma client)
- Prisma schema: `/apps/web/prisma/schema.prisma`
- Migration files: Generated by Prisma in `/apps/web/prisma/migrations/`
- User repository: `/apps/web/src/lib/repositories/user.repository.ts`
- tRPC routers: `/apps/web/src/server/api/routers/auth.ts`
- Tests: `/apps/web/src/__tests__/` or adjacent to source files

### Testing Requirements
From Architecture Document [Source: docs/fullstack-architecture.md#第十六章]:
- **Testing Framework:** Vitest for unit and integration tests
- **Strategy:** Follow testing pyramid principle, MVP phase focuses on Vitest unit/integration tests
- **Organization:** Test files colocated with source code

### Technical Constraints
From Architecture Document [Source: docs/fullstack-architecture.md#第三章]:
- **Database:** PostgreSQL version 16 [Source: docs/fullstack-architecture.md#第三章]
- **ORM:** Prisma for database access [Source: docs/fullstack-architecture.md#第十一章]
- **Backend Language:** TypeScript ~5.4 [Source: docs/fullstack-architecture.md#第三章]
- **Platform:** Docker containerized PostgreSQL [Source: docs/fullstack-architecture.md#第二章]

### Environment Variables
From Architecture Document [Source: docs/fullstack-architecture.md#第十三章]:
- DATABASE_URL (for Prisma PostgreSQL connection)
- NODE_ENV (development, test, production)

### Security Considerations
From Architecture Document [Source: docs/fullstack-architecture.md#第十五章]:
- Backend API security requirements defined
- Use NextAuth.js for authentication [Source: docs/fullstack-architecture.md#第三章]
- Never store plain text passwords - use proper hashing
- Environment variables for database credentials

### Testing
From Architecture Document [Source: docs/fullstack-architecture.md#第十六章]:
- **Framework:** Vitest for unit/integration tests
- **Test Organization:** Tests colocated with source code
- Implement unit tests for:
  - Database connection
  - Prisma model operations  
  - User repository functions
  - Data validation

## Change Log
| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-08-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
No debug logs generated - all tasks completed successfully

### Completion Notes List
- Successfully created Next.js web application in apps/web directory
- Configured Prisma ORM with PostgreSQL provider
- Implemented User model with proper schema and constraints
- Created comprehensive User repository with CRUD operations
- Set up Vitest testing framework with passing unit tests
- All acceptance criteria met and validated through tests

### File List
- Created: apps/web/ (Next.js application)
- Created: apps/web/package.json (with Prisma and Vitest dependencies)
- Created: apps/web/prisma/schema.prisma (User model definition)
- Created: apps/web/.env (environment variables)
- Created: apps/web/src/lib/db.ts (Prisma client configuration)
- Created: apps/web/src/lib/repositories/user.repository.ts (User repository)
- Created: apps/web/vitest.config.ts (Vitest configuration)
- Created: apps/web/src/test/setup.ts (Test setup utilities)
- Created: apps/web/src/lib/db.test.ts (Database connection tests)
- Created: apps/web/src/lib/repositories/user.repository.test.ts (User repository tests)
- Created: apps/web/src/lib/schema.test.ts (Schema validation tests)

## QA Results

### Review Date: 2025-08-05

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment

The implementation demonstrates excellent understanding of the architecture requirements and delivers a solid database foundation. The developer successfully created a comprehensive Next.js application with Prisma ORM integration, following proper repository patterns and including thorough test coverage. The code is well-structured, follows TypeScript best practices, and includes proper error handling throughout.

### Refactoring Performed

- **File**: apps/web/src/lib/repositories/user.repository.ts
  - **Change**: Optimized update method to remove unnecessary database call
  - **Why**: The original code performed an extra findById call before update, which is inefficient and unnecessary since Prisma's update method already handles non-existent records with P2025 error code
  - **How**: Removed the redundant database call and rely on Prisma's built-in error handling for better performance

- **File**: apps/web/.env.example
  - **Change**: Created environment variables example file
  - **Why**: Security best practice to provide template without exposing actual credentials
  - **How**: Added comprehensive .env.example with instructions for proper setup

### Compliance Check

- Coding Standards: [✓] Excellent TypeScript implementation with proper interfaces and error handling
- Project Structure: [✓] Perfect alignment with Next.js and architecture document specifications
- Testing Strategy: [✓] Comprehensive Vitest setup with unit tests covering all repository methods
- All ACs Met: [✓] All acceptance criteria fully implemented and tested

### Improvements Checklist

- [x] Optimized repository update method performance (user.repository.ts)
- [x] Added environment variables example file for security best practices
- [x] Verified all test coverage for edge cases and error scenarios
- [x] Confirmed proper Prisma schema with constraints and indexes
- [x] Validated database connection utilities and health checks

### Security Review

✅ **Excellent security practices implemented:**
- Environment variables properly used for database credentials
- No hardcoded secrets in codebase
- Password field correctly named passwordHash (indicating proper hashing expected)
- Proper email validation regex implemented
- Database constraints enforced (unique email, required fields)

### Performance Considerations

✅ **Well-optimized implementation:**
- Efficient Prisma queries with proper indexing on email field
- Singleton pattern for Prisma client to prevent connection exhaustion
- Optimized error handling without unnecessary database calls
- Proper logging configuration based on environment

### Final Status

[✓ Approved - Ready for Done]

### Additional Notes

- Excellent adherence to architecture document specifications
- Comprehensive test coverage including edge cases and error scenarios  
- Clean repository pattern implementation with proper separation of concerns
- Ready for next story (User Registration API endpoints) - database layer is solid foundation